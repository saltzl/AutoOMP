%%*************************************************************************
%% Legal Notice:
%% This code is offered as-is without any warranty either expressed or
%% implied; without even the implied warranty of MERCHANTABILITY or
%% FITNESS FOR A PARTICULAR PURPOSE!
%% User assumes all risk.
%% In no event shall the IEEE or any contributor to this code be liable for
%% any damages or losses, including, but not limited to, incidental,
%% consequential, or any other damages, resulting from the use or misuse
%% of any information contained here.
%%
%% All comments are the opinions of their respective authors and are not
%% necessarily endorsed by the IEEE.
%%
%% This work is distributed under the LaTeX Project Public License (LPPL)
%% ( http://www.latex-project.org/ ) version 1.3, and may be freely used,
%% distributed and modified. A copy of the LPPL, version 1.3, is included
%% in the base LaTeX documentation of all distributions of LaTeX released
%% 2003/12/01 or later.
%% Retain all contribution notices and credits.
%% ** Modified files should be clearly indicated as such, including  **
%% ** renaming them and changing author support contact information. **
%%*************************************************************************
\documentclass[conference]{IEEEtran}
% Some Computer Society conferences also require the compsoc mode option,
% but others use the standard conference format.
%
% If IEEEtran.cls has not been installed into the LaTeX system files,
% manually specify the path to it like:
% \documentclass[conference]{../sty/IEEEtran}

% Some very useful LaTeX packages include:
% (uncomment the ones you want to load)

% *** MISC UTILITY PACKAGES ***
%
%\usepackage{ifpdf}
% Heiko Oberdiek's ifpdf.sty is very useful if you need conditional
% compilation based on whether the output is pdf or dvi.
% usage:
% \ifpdf
%   % pdf code
% \else
%   % dvi code
% \fi
% The latest version of ifpdf.sty can be obtained from:
% http://www.ctan.org/pkg/ifpdf
% Also, note that IEEEtran.cls V1.7 and later provides a builtin
% \ifCLASSINFOpdf conditional that works the same way.
% When switching from latex to pdflatex and vice-versa, the compiler may
% have to be run twice to clear warning/error messages.

% *** CITATION PACKAGES ***
%
%\usepackage{cite}
% cite.sty was written by Donald Arseneau
% V1.6 and later of IEEEtran pre-defines the format of the cite.sty package
% \cite{} output to follow that of the IEEE. Loading the cite package will
% result in citation numbers being automatically sorted and properly
% "compressed/ranged". e.g., [1], [9], [2], [7], [5], [6] without using
% cite.sty will become [1], [2], [5]--[7], [9] using cite.sty. cite.sty's
% \cite will automatically add leading space, if needed. Use cite.sty's
% noadjust option (cite.sty V3.8 and later) if you want to turn this off
% such as if a citation ever needs to be enclosed in parenthesis.
% cite.sty is already installed on most LaTeX systems. Be sure and use
% version 5.0 (2009-03-20) and later if using hyperref.sty.
% The latest version can be obtained at:
% http://www.ctan.org/pkg/cite
% The documentation is contained in the cite.sty file itself.

% *** GRAPHICS RELATED PACKAGES ***
%
\ifCLASSINFOpdf
\usepackage[pdftex]{graphicx}
  % declare the path(s) where your graphic files are
  % \graphicspath{{../pdf/}{../jpeg/}}
  % and their extensions so you won't have to specify these with
  % every instance of \includegraphics
  % \DeclareGraphicsExtensions{.pdf,.jpeg,.png}
\else
  % or other class option (dvipsone, dvipdf, if not using dvips). graphicx
  % will default to the driver specified in the system graphics.cfg if no
  % driver is specified.
  % \usepackage[dvips]{graphicx}
  % declare the path(s) where your graphic files are
  % \graphicspath{{../eps/}}
  % and their extensions so you won't have to specify these with
  % every instance of \includegraphics
  % \DeclareGraphicsExtensions{.eps}
\fi
% graphicx was written by David Carlisle and Sebastian Rahtz. It is
% required if you want graphics, photos, etc. graphicx.sty is already
% installed on most LaTeX systems. The latest version and documentation
% can be obtained at:
% http://www.ctan.org/pkg/graphicx
% Another good source of documentation is "Using Imported Graphics in
% LaTeX2e" by Keith Reckdahl which can be found at:
% http://www.ctan.org/pkg/epslatex
%
% latex, and pdflatex in dvi mode, support graphics in encapsulated
% postscript (.eps) format. pdflatex in pdf mode supports graphics
% in .pdf, .jpeg, .png and .mps (metapost) formats. Users should ensure
% that all non-photo figures use a vector format (.eps, .pdf, .mps) and
% not a bitmapped formats (.jpeg, .png). The IEEE frowns on bitmapped formats
% which can result in "jaggedy"/blurry rendering of lines and letters as
% well as large increases in file sizes.
%
% You can find documentation about the pdfTeX application at:
% http://www.tug.org/applications/pdftex

% *** MATH PACKAGES ***
%
\usepackage{amsmath}
\usepackage{amssymb}
% A popular package from the American Mathematical Society that provides
% many useful and powerful commands for dealing with mathematics.
%
% Note that the amsmath package sets \interdisplaylinepenalty to 10000
% thus preventing page breaks from occurring within multiline equations. Use:
%\interdisplaylinepenalty=2500
% after loading amsmath to restore such page breaks as IEEEtran.cls normally
% does. amsmath.sty is already installed on most LaTeX systems. The latest
% version and documentation can be obtained at:
% http://www.ctan.org/pkg/amsmath

% *** SPECIALIZED LIST PACKAGES ***
%
%% \usepackage{algorithmicx}
%% \usepackage{algpseudocode}
% algorithmic.sty was written by Peter Williams and Rogerio Brito.
% This package provides an algorithmic environment fo describing algorithms.
% You can use the algorithmic environment in-text or within a figure
% environment to provide for a floating algorithm. Do NOT use the algorithm
% floating environment provided by algorithm.sty (by the same authors) or
% algorithm2e.sty (by Christophe Fiorio) as the IEEE does not use dedicated
% algorithm float types and packages that provide these will not provide
% correct IEEE style captions. The latest version and documentation of
% algorithmic.sty can be obtained at:
% http://www.ctan.org/pkg/algorithms
% Also of interest may be the (relatively newer and more customizable)
% algorithmicx.sty package by Szasz Janos:
% http://www.ctan.org/pkg/algorithmicx

% *** ALIGNMENT PACKAGES ***
%
%\usepackage{array}
% Frank Mittelbach's and David Carlisle's array.sty patches and improves
% the standard LaTeX2e array and tabular environments to provide better
% appearance and additional user controls. As the default LaTeX2e table
% generation code is lacking to the point of almost being broken with
% respect to the quality of the end results, all users are strongly
% advised to use an enhanced (at the very least that provided by array.sty)
% set of table tools. array.sty is already installed on most systems. The
% latest version and documentation can be obtained at:
% http://www.ctan.org/pkg/array

% IEEEtran contains the IEEEeqnarray family of commands that can be used to
% generate multiline equations as well as matrices, tables, etc., of high
% quality.

% *** SUBFIGURE PACKAGES ***
%\ifCLASSOPTIONcompsoc
%  \usepackage[caption=false,font=normalsize,labelfont=sf,textfont=sf]{subfig}
%\else
%  \usepackage[caption=false,font=footnotesize]{subfig}
%\fi
% subfig.sty, written by Steven Douglas Cochran, is the modern replacement
% for subfigure.sty, the latter of which is no longer maintained and is
% incompatible with some LaTeX packages including fixltx2e. However,
% subfig.sty requires and automatically loads Axel Sommerfeldt's caption.sty
% which will override IEEEtran.cls' handling of captions and this will result
% in non-IEEE style figure/table captions. To prevent this problem, be sure
% and invoke subfig.sty's "caption=false" package option (available since
% subfig.sty version 1.3, 2005/06/28) as this is will preserve IEEEtran.cls
% handling of captions.
% Note that the Computer Society format requires a larger sans serif font
% than the serif footnote size font used in traditional IEEE formatting
% and thus the need to invoke different subfig.sty package options depending
% on whether compsoc mode has been enabled.
%
% The latest version and documentation of subfig.sty can be obtained at:
% http://www.ctan.org/pkg/subfig

% *** FLOAT PACKAGES ***
%
%\usepackage{fixltx2e}
% fixltx2e, the successor to the earlier fix2col.sty, was written by
% Frank Mittelbach and David Carlisle. This package corrects a few problems
% in the LaTeX2e kernel, the most notable of which is that in current
% LaTeX2e releases, the ordering of single and double column floats is not
% guaranteed to be preserved. Thus, an unpatched LaTeX2e can allow a
% single column figure to be placed prior to an earlier double column
% figure.
% Be aware that LaTeX2e kernels dated 2015 and later have fixltx2e.sty's
% corrections already built into the system in which case a warning will
% be issued if an attempt is made to load fixltx2e.sty as it is no longer
% needed.
% The latest version and documentation can be found at:
% http://www.ctan.org/pkg/fixltx2e


%\usepackage{stfloats}
% stfloats.sty was written by Sigitas Tolusis. This package gives LaTeX2e
% the ability to do double column floats at the bottom of the page as well
% as the top. (e.g., "\begin{figure*}[!b]" is not normally possible in
% LaTeX2e). It also provides a command:
%\fnbelowfloat
% to enable the placement of footnotes below bottom floats (the standard
% LaTeX2e kernel puts them above bottom floats). This is an invasive package
% which rewrites many portions of the LaTeX2e float routines. It may not work
% with other packages that modify the LaTeX2e float routines. The latest
% version and documentation can be obtained at:
% http://www.ctan.org/pkg/stfloats
% Do not use the stfloats baselinefloat ability as the IEEE does not allow
% \baselineskip to stretch. Authors submitting work to the IEEE should note
% that the IEEE rarely uses double column equations and that authors should try
% to avoid such use. Do not be tempted to use the cuted.sty or midfloat.sty
% packages (also by Sigitas Tolusis) as the IEEE does not format its papers in
% such ways.
% Do not attempt to use stfloats with fixltx2e as they are incompatible.
% Instead, use Morten Hogholm'a dblfloatfix which combines the features
% of both fixltx2e and stfloats:
%
% \usepackage{dblfloatfix}
% The latest version can be found at:
% http://www.ctan.org/pkg/dblfloatfix

% *** PDF, URL AND HYPERLINK PACKAGES ***
%
%\usepackage{url}
% url.sty was written by Donald Arseneau. It provides better support for
% handling and breaking URLs. url.sty is already installed on most LaTeX
% systems. The latest version and documentation can be obtained at:
% http://www.ctan.org/pkg/url
% Basically, \url{my_url_here}.

% *** Do not adjust lengths that control margins, column widths, etc. ***
% *** Do not use packages that alter fonts (such as pslatex).         ***
% There should be no need to do such things with IEEEtran.cls V1.6 and later.
% (Unless specifically asked to do so by the journal or conference you plan
% to submit to, of course. )

% correct bad hyphenation here
\hyphenation{op-tical net-works semi-conduc-tor}

\begin{document}
\title{AutoOMP:\\Automatic OpenMP parallelization of code using LLVM}

\author{\IEEEauthorblockN{McCall Saltzman}
\IEEEauthorblockA{School of Science\\
Rensselaer Polytechnic Institute\\
110 8th St, Troy NY 12180}
\and
\IEEEauthorblockN{Adam Freeman}
\IEEEauthorblockA{School of Science\\
Rensselaer Polytechnic Institute\\
110 8th St, Troy NY 12180}}

\maketitle

% As a general rule, do not put math, special symbols or citations
% in the abstract
\begin{abstract}
   AutoOMP attempts to leverage the flexibility and power of the LLVM
   compiler infrastructure to accelerate cases of serial code using
   OpenMP. First, LLVM is used to lower code to an intermediate
   language. Then, using the LLVM code analysis framework, AutoOMP
   detects which loops can be safely parallelized and which can
   not. AutoOMP breaks out the parallelizable loops into their own
   functions, creating OpenMP loops out of them.
\end{abstract}

% For peerreview papers, this IEEEtran command inserts a page break and
% creates the second title. It will be ignored for other modes.
\IEEEpeerreviewmaketitle

\section{Introduction}
Writing parallel code has always been a more complicated task than
writing serial code. With parallel code, the programmer needs to
consider the impact of thread dependencies, shared memory and
variables, and many other factors which can cause deadlock or
incorrect code. However with modern parallel architectures it becomes
increasingly important that programs and software be able to take
advantage of the speedup from the modern parallel
architectures.

There have been many attempts to ease the burden of parallelization on
the programmer. New languages have been developed with parallelization
in mind. Frameworks have made it easier than ever to integrate
parallel code into a serial project or construct an entire code base
out of parallel code. However none of these attempts have taken over
the programming world, due to a lack of programmer familiarity with
the languages and frameworks. Clearly, there is a need for a
parallelization mechanism which does not place any burden on the
programmer at all, allowing for seamless and entirely hassle free
parallelization. AutoOMP attempts to fill this niche by adding
parallelization at compile time using LLVM, and integrating code with
the OpenMP parallelization framework.

\subsection{The LLVM Compiler Infrastructure}
The LLVM compiler infrastructure is a ``collection of modular and
reusable compiler and toolchain technologies.'' \cite{llvm-home} It
has gained immense popularity in recent years due to its wide range of
supported languages and architectures, and quick additions of new
language standards such as c++17 in the C++ frontend to LLVM,
clang. While the clang frontend for C and C++ is one of the most
popular languages used with LLVM, the compiler supports many other
languages through the use of different front ends. Other popular
languages include Common Lisp, Fortran, Haskell, Java (bytecode),
Python, and Swift. Any of the languages that LLVM supports can be
compiled to any of the architectures that LLVM supports, which include
every major architecture and some unconventional ones. For example, a
program written in C++ can be compiled to x86 machine code. Haskell
can be compiled to Javascript using LLVM.

The LLVM compiler infrastructure achieves this flexibility through the
use of an intermediate language. A program compiled using LLVM is
first read by one of the many front ends to LLVM. The job of an LLVM
front end is to parse and convert human readable code into the LLVM
Intermediate Language, henceforth simply called IR. While the initial
source code varies widely between language and paradigm, the IR
produced from the front end will always have the same structure and
can be operated on independently of the source language.

Due to the uniformity of the structure, LLVM runs several optimization
and analysis passes once the code has been converted to IR, again
regardless of the source language. Some of these passes are purely for
analysis, to collect information to later be used in optimization
passes. These analysis passes can collect such information as the
Dominator front for a function, or collecting information about the
loops in the program. These analysis passes then provide information
about the code to optimization passes, which can more easily make
educated decisions about how to optimize the code and how to ensure
the safety and correctness of the code. The optimization passes can
state to the pass manager which other passes they depend on so that
the required information is present when that pass is run. This also
defines the order in which passes are run. This can also control the
order of optimization passes, so that a pass that must be run last or
before other passes can specify when it will run.

Once all the optimization passes run, LLVM uses a backend to lower the
IR to machine code. Many backends exist for LLVM covering all major
architectures and many esoteric ones as well. This is the stage at
which architecture specific optimizations take place.

\subsection{OpenMP}
OpenMP, short for Open Multi-Processing, is an API for locally running
many threads to achieve parallelization. OpenMP uses the fork-join
model, meaning that there is a master thread that is spawning slave
threads to aid in the computation. OpenMP aims to make the job of
parallelization extremely easy for the programmer, and to do so uses
preprocessor macros, such as \texttt{\#pragma omp parallel} to mark
certain sections of code as parallelizable. The compiler will then see
the sections of code marked as such, and transparently break them out into a
separate function, replacing the original section of code with a
function call to openMP libraries. The called function will then fork
numerous times depending on the environment and call the broken out
section of code.

\section{AutoOMP Architecture}
AutoOMP is implemented as an LLVM optimization pass. As every part of
LLVM is, AutoOMP is written using C++. More specifically, AutoOMP is
implemented as a Module pass, which means that the pass gets run once
on each module. This differs from, say, a function pass which gets run
once and separately on each function. AutoOMP must be run as a module
pass due to the forced process of breaking out loops into separate
functions. A function pass does not have the ability to touch
functions outside its own scope, so a higher scope is needed in order
to create new functions. Our module pass specifies that it must be run
after two other passes - the \texttt{LoopInfoWrapperPass} and the
\texttt{DominatorTreeWrapperPass}. These passes are wrappers for
analysis passes that gather information on all the loops in the
module, and information on the Dominator tree for every function. One
notes that the dominator tree pass is a function pass, so access to
the analysis from this pass must also specify a specific function to
retrieve analysis from.

When our AutoOMP pass is run, each function in the module is looped
though. We then retrieve the list of loops from the previously run
\texttt{LoopInfoWrapperPass}, and filter it based on which functions
are in the loop. This filtering and separate retrieval of the loops is
necessary because of the next step in our loop selection process,
which is to query the dominator tree for each loop. As the dominator
tree pass is a function pass and not a module pass, a query to this
pass requires that you specify a specific function to obtain
information about. Since we are filtering the set of all loops in the
module by one particular function, we can use this function to query
the previously run dominator tree analysis pass.

We then iterate over every loop to test if it can be separated out and
parallelized. This is basically a further filter to eliminate all
loops that don't fulfill a certain set of properties that we
define. For example, the loop must be in simplified form, a form specified
by the llvm IR as having a loop variable counting up from zero. We also
check by examining its starting and terminating instructions, to verify
that they are well formed and branch to the loop header and exit. We also
rule out any loops which contain a function call, as this can easily
lead to complicated dependencies and incorrectness in parallelization.

Once a loop is selected for parallelization, we first extract the loop
into a separate function. After a few sanity checks like ensuring that
the loop actually has instructions before and after its execution, we
use a LLVM CodeExtractor to extract the entire code block containing
of the loop into a separate function.

After a loop becomes its own function, we need to create the
intermediate OpenMP function that will call our newly separated loop,
as well as construct some scaffolding into the newly extracted
function. This includes such things as adding parsing for arguments
and establishing a new scope for this function. These changes are also
necessary for being called by openMP, as openMP uses them to establish
a thread local context. Once we are sure that the extracted function
will have all the pieces that openMP may require, we create a function
call to the openMP fork function with our recently extracted function
as an argument. Also passed to this function are variables that are
required by the scope of the extracted function but not necessarily
changing during the lifetime of the loop. The dominator tree is used
indirectly in this process. We then insert the newly created call to
fork in openMP into the original code where the loop used to be,
hopefully creating a seamless call to openMP and seamlessly adding
parallelization.




\section{Conclusion}

Unfortunately, in the time available we were unable to fully implement runnable automatic
open mp conversion. The documentation available for the OpenMP implementation is limited
and as such we were unable to find the appropriate calling conventions for both
\texttt{kpmc\_fork\_call}, and \texttt{kpmc\_for\_static\_init}. However, the project was to some degree a success.
The AutoOMP pass correctly identifies a subset of parallelizable loops, and can separate them
from the main function into a callable region. Additionally, the loop variables, and memory accesses
can be identified, analyzed for dependencies, and properly added to the header region as seen in
OpenMP code compiled with Clang. This shows that if the calling conventions for the missing
functions can be figured out, the pass will be able to produce runnable open mp code.

In summary, LLVM is a promising framework for adding parallelism to existing codebases.
Once completely working, the AutoOMP pass will enable programmers to search for speedups
in their code without any more overhead than adding a compiler option. While the approach
taken by AutoOMP may not have been the most performant, enabling programmers to test speeding
up their code may also allow them to see where they need to optimize for better performance.
While LLVM currently does support OpenMP, the documentation in that area is distinctly lacking,
leading to the issues AutoOMP is experiencing with malformed call instructions. If resolved,
basic parallelism will be available to all programs that can target LLVM IR.


\subsection{Future Work}


Moving forward, the AutoOMP project will be continued. We aim to find the proper way to build these
missing call instructions, and furthermore, to narrow down the range of loops we can parallelize.
Additionally, we intend to use more of the code analysis tools available within LLVM to find
special case loops and parallelize them differently.
Once the code is runnable, we intend to compare performance and accuracy of several popular benchmark suites
in a few different languages, both to verify that the loops we accelerate are safe to do so, and that
the speedup gained from this is both useful and substantial.
% An example of a floating figure using the graphicx package.
% Note that \label must occur AFTER (or within) \caption.
% For figures, \caption should occur after the \includegraphics.
% Note that IEEEtran v1.7 and later has special internal code that
% is designed to preserve the operation of \label within \caption
% even when the captionsoff option is in effect. However, because
% of issues like this, it may be the safest practice to put all your
% \label just after \caption rather than within \caption{}.
%
% Reminder: the "draftcls" or "draftclsnofoot", not "draft", class
% option should be used if it is desired that the figures are to be
% displayed while in draft mode.
%
%\begin{figure}[!t]
%\centering
%\includegraphics[width=2.5in]{myfigure}
% where an .eps filename suffix will be assumed under latex,
% and a .pdf suffix will be assumed for pdflatex; or what has been declared
% via \DeclareGraphicsExtensions.
%\caption{Simulation results for the network.}
%\label{fig_sim}
%\end{figure}

% Note that the IEEE typically puts floats only at the top, even when this
% results in a large percentage of a column being occupied by floats.


% An example of a double column floating figure using two subfigures.
% (The subfig.sty package must be loaded for this to work.)
% The subfigure \label commands are set within each subfloat command,
% and the \label for the overall figure must come after \caption.
% \hfil is used as a separator to get equal spacing.
% Watch out that the combined width of all the subfigures on a
% line do not exceed the text width or a line break will occur.
%
%\begin{figure*}[!t]
%\centering
%\subfloat[Case I]{\includegraphics[width=2.5in]{box}%
%\label{fig_first_case}}
%\hfil
%\subfloat[Case II]{\includegraphics[width=2.5in]{box}%
%\label{fig_second_case}}
%\caption{Simulation results for the network.}
%\label{fig_sim}
%\end{figure*}
%
% Note that often IEEE papers with subfigures do not employ subfigure
% captions (using the optional argument to \subfloat[]), but instead will
% reference/describe all of them (a), (b), etc., within the main caption.
% Be aware that for subfig.sty to generate the (a), (b), etc., subfigure
% labels, the optional argument to \subfloat must be present. If a
% subcaption is not desired, just leave its contents blank,
% e.g., \subfloat[].


% An example of a floating table. Note that, for IEEE style tables, the
% \caption command should come BEFORE the table and, given that table
% captions serve much like titles, are usually capitalized except for words
% such as a, an, and, as, at, but, by, for, in, nor, of, on, or, the, to
% and up, which are usually not capitalized unless they are the first or
% last word of the caption. Table text will default to \footnotesize as
% the IEEE normally uses this smaller font for tables.
% The \label must come after \caption as always.
%
%\begin{table}[!t]
%% increase table row spacing, adjust to taste
%\renewcommand{\arraystretch}{1.3}
% if using array.sty, it might be a good idea to tweak the value of
% \extrarowheight as needed to properly center the text within the cells
%\caption{An Example of a Table}
%\label{table_example}
%\centering
%% Some packages, such as MDW tools, offer better commands for making tables
%% than the plain LaTeX2e tabular which is used here.
%\begin{tabular}{|c||c|}
%\hline
%One & Two\\
%\hline
%Three & Four\\
%\hline
%\end{tabular}
%\end{table}


% Note that the IEEE does not put floats in the very first column
% - or typically anywhere on the first page for that matter. Also,
% in-text middle ("here") positioning is typically not used, but it
% is allowed and encouraged for Computer Society conferences (but
% not Computer Society journals). Most IEEE journals/conferences use
% top floats exclusively.
% Note that, LaTeX2e, unlike IEEE journals/conferences, places
% footnotes above bottom floats. This can be corrected via the
% \fnbelowfloat command of the stfloats package.



% trigger a \newpage just before the given reference
% number - used to balance the columns on the last page
% adjust value as needed - may need to be readjusted if
% the document is modified later
%\IEEEtriggeratref{8}
% The "triggered" command can be changed if desired:
%\IEEEtriggercmd{\enlargethispage{-5in}}

% references section

% can use a bibliography generated by BibTeX as a .bbl file
% BibTeX documentation can be easily obtained at:
% http://mirror.ctan.org/biblio/bibtex/contrib/doc/
% The IEEEtran BibTeX style support page is at:
% http://www.michaelshell.org/tex/ieeetran/bibtex/
%\bibliographystyle{IEEEtran}
% argument is your BibTeX string definitions and bibliography database(s)
%\bibliography{IEEEabrv,../bib/paper}
%
% <OR> manually copy in the resultant .bbl file
% set second argument of \begin to the number of references
% (used to reserve space for the reference number labels box)
\begin{thebibliography}{1}
\bibitem{llvm-home}
“LLVM Overview,” The LLVM Compiler Infrastructure Project, [Online]. Available: https://llvm.org/. [Accessed: 03-May-2017].
\end{thebibliography}
\end{document}
